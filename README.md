# Flow Repo

ğŸš€ **ç”Ÿäº§çº§ Dart æ•°æ®å¿«ç…§ä¸å¢é‡åŒæ­¥ç³»ç»Ÿ**

[![Dart](https://img.shields.io/badge/Dart-3.0+-blue.svg)](https://dart.dev)
[![License](https://img.shields.io/badge/License-AGPL%203.0-green.svg)](LICENSE)
[![Platform](https://img.shields.io/badge/Platform-macOS%20%7C%20Linux%20%7C%20Windows%20%7C%20Android-lightgrey.svg)](https://dart.dev)

---

## ğŸ’¡ é¡¹ç›®äº®ç‚¹

### ğŸ”¥ å¤šç­–ç•¥åˆ†å—å¼•æ“

Flow Repo æ˜¯**é¦–ä¸ªåœ¨ Dart ç”Ÿæ€ä¸­åŒæ—¶å®ç°ä¸‰ç§åˆ†å—ç­–ç•¥**çš„æ•°æ®åŒæ­¥ç³»ç»Ÿï¼š

#### 1ï¸âƒ£ **å›ºå®šåˆ†å— (Fixed-Size Chunking)** - ç”Ÿäº§æ¨è â­ï¸
- **å—å¤§å°**: 8MB å›ºå®šåˆ†å—
- **ä¼˜åŠ¿**: 
  - å—è¾¹ç•Œç¨³å®šï¼Œå¢é‡åŒæ­¥æ•ˆæœæä½³
  - å®æµ‹èŠ‚çœ **98%+** æµé‡
  - é€‚åˆé¢‘ç¹ä¿®æ”¹çš„æ•°æ®ï¼ˆå¦‚ SQLite æ•°æ®åº“ï¼‰
- **æ€§èƒ½**: 273MB æ•°æ®åº“ä¿®æ”¹ 1 æ¡è®°å½•ä»…ä¼ è¾“ 5.25MB

#### 2ï¸âƒ£ **å†…å®¹å®šä¹‰åˆ†å— (Content-Defined Chunking, CDC)** - FFI åŠ é€Ÿ
- **å®ç°**: åŸºäº [restic/chunker](https://github.com/restic/chunker) çš„ Go FFI å°è£…
- **å¤šå¹³å°æ”¯æŒ**: 
  - âœ… macOS (Universal Binary: ARM64 + AMD64)
  - âœ… Linux (AMD64 + ARM64)
  - âœ… Windows (AMD64)
  - âœ… Android (ARM64 + x86_64)
- **ç®—æ³•**: Rabin Fingerprint with Polynomial `0x3DA3358B4DC173`
- **å—å¤§å°**: 512KB ~ 8MB åŠ¨æ€è°ƒæ•´
- **ä¼˜åŠ¿**: 
  - å—è¾¹ç•Œå†…å®¹æ„ŸçŸ¥ï¼Œæ–‡ä»¶æ’å…¥/åˆ é™¤åœºæ™¯è¡¨ç°æ›´ä¼˜
  - åŸç”Ÿ Go æ€§èƒ½
  - è·¨å¹³å° FFI è°ƒç”¨

#### 3ï¸âƒ£ **ä¼˜åŒ–åˆ†å— (Optimized Chunking)** - Isolate å¹¶å‘
- **æŠ€æœ¯**: Dart Isolate å¤šæ ¸å¹¶å‘å¤„ç†
- **ç­–ç•¥**: 
  - å°æ–‡ä»¶ (<10MB): å•çº¿ç¨‹å¤„ç†
  - å¤§æ–‡ä»¶ (â‰¥10MB): Isolate å¹¶å‘åˆ†å—
- **ä¼˜åŠ¿**: å……åˆ†åˆ©ç”¨å¤šæ ¸ CPUï¼Œå¤„ç†å¤§æ–‡ä»¶æ—¶æ€§èƒ½æå‡æ˜¾è‘—

### ğŸ› ï¸ è·¨å¹³å° FFI æ¶æ„

**é¦–ä¸ªåœ¨ Dart ä¸­ä½¿ç”¨ Go FFI å®ç° CDC åˆ†å—çš„å¼€æºé¡¹ç›®**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Dart Layer    â”‚  â† Flutter/Dart åº”ç”¨
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  FFI Bindings   â”‚  â† dart:ffi è·¨å¹³å°ç»‘å®š
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Go Library    â”‚  â† restic/chunker (C-shared)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Native Binary  â”‚  â† .dylib / .so / .dll
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æŠ€æœ¯ç‰¹ç‚¹**:
- ğŸ”§ è‡ªåŠ¨åŒ–æ„å»ºè„šæœ¬ (`build.sh`)
- ğŸ¯ åŠ¨æ€åº“åŠ è½½ï¼Œè‡ªåŠ¨æ£€æµ‹å¹³å°
- ğŸ“¦ é›¶ä¾èµ–è¿è¡Œæ—¶ï¼ˆåº“å·²é¢„ç¼–è¯‘ï¼‰
- ğŸ”’ ç±»å‹å®‰å…¨çš„ FFI ç»‘å®š

### ğŸ¯ æè‡´æ€§èƒ½è¡¨ç°

#### å¢é‡åŒæ­¥å®æµ‹

**æµ‹è¯•åœºæ™¯**: 273MB SQLite æ•°æ®åº“æ–°å¢ 1 æ¡è®°å½•

| æŒ‡æ ‡ | æ•°å€¼ | èŠ‚çœç‡ |
|------|------|--------|
| **ä¸Šä¼ æµé‡** | **5.25MB** | 98.08% â¬‡ï¸ |
| **ä¸‹è½½æµé‡** | **5.25MB** | 98.08% â¬‡ï¸ |
| **ç´¢å¼•åˆ›å»º** | 1.94s | - |
| **ç«¯åˆ°ç«¯åŒæ­¥** | 7-9s | - |
| **æ•°æ®ä¸€è‡´æ€§** | 100% | âœ… |

#### ä¸ Go ç‰ˆæœ¬å¯¹æ¯”

| é¡¹ç›® | Dart (Flow Repo) | Go (DejaVu) | å¤‡æ³¨ |
|------|------------------|-------------|------|
| å¢é‡æµé‡ | 5.25MB | 981KB | Go CDC æ›´ä¼˜ |
| åŒæ­¥é€Ÿåº¦ | 16.25s | 9.08s | Go æ›´å¿« |
| **ç´¢å¼•åˆ›å»º** | **1.94s** | 3.37s | **Dart å¿« 42%** â­ï¸ |
| å¹³å°æ”¯æŒ | Dart/Flutter å…¨å¹³å° | Go æœåŠ¡ç«¯ | Dart ç”Ÿæ€ä¼˜åŠ¿ |

### ğŸ” ä¼ä¸šçº§æ•°æ®å®‰å…¨

```
åŸå§‹æ•°æ® â†’ åˆ†å— â†’ SHA-1 å“ˆå¸Œ â†’ ZLib å‹ç¼© â†’ AES-256 åŠ å¯† â†’ äº‘ç«¯å­˜å‚¨
   â†“                                                    â†“
100% å†…å®¹å»é‡                                   äº‘ç«¯æ— æ³•è§£å¯†
```

- **åŠ å¯†ç®—æ³•**: AES-256-CBC
- **å¯†é’¥ç®¡ç†**: æœ¬åœ°å¯†é’¥ï¼Œäº‘ç«¯é›¶çŸ¥è¯†
- **å†…å®¹å¯»å€**: SHA-1 å“ˆå¸Œï¼Œè‡ªåŠ¨å»é‡
- **å‹ç¼©æ¯”**: å¹³å‡ 40-60% (æ ¹æ®æ•°æ®ç±»å‹)

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…

```bash
# 1. å…‹éš†ä»“åº“
git clone https://github.com/your-org/flow-repo.git
cd flow-repo

# 2. å®‰è£…ä¾èµ–
dart pub get

# 3. (å¯é€‰) æ„å»º FFI åˆ†å—åº“ - ç”¨äº CDC åˆ†å—
cd chunker-ffi
./build.sh
cd ..
```

### é…ç½®

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```env
# åŠ å¯†å¯†é’¥ (32 å­—èŠ‚)
AES_KEY=your_32_byte_aes_key_here_12345

# é˜¿é‡Œäº‘ OSS é…ç½®
OSS_ACCESS_KEY_ID=your_access_key
OSS_ACCESS_KEY_SECRET=your_secret_key
OSS_BUCKET_NAME=your_bucket_name
OSS_ENDPOINT=oss-cn-shenzhen.aliyuncs.com
OSS_REGION=oss-cn-shenzhen
```

### ä½¿ç”¨

```bash
# åˆ›å»ºå¿«ç…§ç´¢å¼•
dart run bin/main.dart index -d ./data --memo "Initial backup"

# åŒæ­¥åˆ°äº‘ç«¯ (è‡ªåŠ¨æ£€æµ‹ä¸Šä¼ /ä¸‹è½½æ–¹å‘)
dart run bin/main.dart sync -d ./data

# åŒæ­¥åˆ°æ–°è®¾å¤‡ (ä½¿ç”¨ä¸åŒçš„æœ¬åœ°ä»“åº“è·¯å¾„)
dart run bin/main.dart sync -d ./data-device2 -r ./.flow-repo-device2
```

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### åˆ†å—å¼•æ“å¯¹æ¯”

| ç‰¹æ€§ | å›ºå®šåˆ†å— | CDC (FFI) | ä¼˜åŒ–åˆ†å— |
|------|---------|-----------|---------|
| **å®ç°è¯­è¨€** | Dart | Go (FFI) | Dart |
| **å—å¤§å°** | 8MB å›ºå®š | 512KB-8MB åŠ¨æ€ | 8MB å›ºå®š |
| **ç®—æ³•å¤æ‚åº¦** | O(n) | O(n) | O(n) |
| **å¹¶å‘æ”¯æŒ** | âŒ | âœ… (Go åŸç”Ÿ) | âœ… (Isolate) |
| **å¢é‡æ•ˆæœ** | æä½³ (98%+) | æ›´ä½³ (99%+) | æä½³ (98%+) |
| **é€‚ç”¨åœºæ™¯** | è¿½åŠ å¼æ•°æ®åº“ | æ’å…¥/åˆ é™¤åœºæ™¯ | å¤§æ–‡ä»¶å¤„ç† |
| **ä¾èµ–** | æ—  | éœ€ç¼–è¯‘ .dylib/.so | æ—  |

### æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ç´¢å¼•åˆ›å»ºé˜¶æ®µ                             â”‚
â”‚                                                                â”‚
â”‚  æ–‡ä»¶æ‰«æ â†’ åˆ†å—å¼•æ“ â†’ SHA-1 å“ˆå¸Œ â†’ ç´¢å¼•æ„å»º â†’ å‹ç¼©å­˜å‚¨        â”‚
â”‚              â†“                                                 â”‚
â”‚        å›ºå®š / CDC / ä¼˜åŒ–                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       åŒæ­¥é˜¶æ®µ                                 â”‚
â”‚                                                                â”‚
â”‚  å¯¹æ¯”ç´¢å¼• â†’ ç¼ºå¤±å—åˆ—è¡¨ â†’ ZLib å‹ç¼© â†’ AES-256 åŠ å¯† â†’ äº‘ç«¯ä¸Šä¼    â”‚
â”‚      â†“                                                         â”‚
â”‚  è‡ªåŠ¨å»é‡ (SHA-1 å†…å®¹å¯»å€)                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä»“åº“ç»“æ„

```
.flow-repo/
â”œâ”€â”€ indexes/          # ğŸ“‹ å¿«ç…§ç´¢å¼• (ä»…å‹ç¼©)
â”‚   â””â”€â”€ <sha1-id>
â”œâ”€â”€ objects/          # ğŸ“¦ æ•°æ®å— (å‹ç¼© + åŠ å¯†)
â”‚   â””â”€â”€ <2-char>/
â”‚       â””â”€â”€ <sha1-id>
â”œâ”€â”€ files/            # ğŸ“„ æ–‡ä»¶å…ƒæ•°æ® (å‹ç¼© + åŠ å¯†)
â”‚   â””â”€â”€ <2-char>/
â”‚       â””â”€â”€ <sha1-id>
â””â”€â”€ refs/             # ğŸ”– å¼•ç”¨æŒ‡é’ˆ
    â””â”€â”€ latest        # æœ€æ–°å¿«ç…§å¼•ç”¨
```

---

## ğŸ”¬ åˆ†å—å¼•æ“è¯¦è§£

### FFI åˆ†å—åº“æ„å»º

Flow Repo æ”¯æŒé€šè¿‡ FFI è°ƒç”¨ Go å®ç°çš„ CDC åˆ†å—å¼•æ“ï¼š

```bash
cd chunker-ffi
./build.sh
```

**æ„å»ºäº§ç‰©**:
- macOS: `lib/native/libchunker.dylib` (Universal Binary)
- Linux: `lib/native/libchunker_linux_{amd64,arm64}.so`
- Windows: `lib/native/libchunker.dll`
- Android: `lib/native/libchunker_android_{arm64,amd64}.so`

**è¯¦ç»†æ–‡æ¡£**: å‚è§ [`chunker-ffi/BUILD_GUIDE.md`](chunker-ffi/BUILD_GUIDE.md)

### Dart ä¸­ä½¿ç”¨ CDC åˆ†å—

```dart
import 'package:flow_repo/util/chunker_ffi.dart';

final chunker = ChunkerFFI();
final handle = chunker.chunkerNew('/path/to/file');

while (true) {
  final chunk = chunker.chunkerNext(handle);
  if (chunk == null) break; // EOF
  
  // å¤„ç†åˆ†å—æ•°æ®
  print('Chunk size: ${chunk.length}');
}

chunker.chunkerClose(handle);
```

### Isolate å¹¶å‘åˆ†å—

```dart
import 'package:flow_repo/util/chunker_optimized.dart';

// è‡ªåŠ¨æ ¹æ®æ–‡ä»¶å¤§å°é€‰æ‹©å¹¶å‘ç­–ç•¥
final chunks = await ChunkerOptimized.chunkFile('/path/to/large/file');

for (final chunk in chunks) {
  print('Chunk ID: ${chunk.id}, Size: ${chunk.length}');
}
```

---

## ğŸŒŸ æ ¸å¿ƒåŠŸèƒ½

- âœ… **ä¸‰ç§åˆ†å—ç­–ç•¥** - å›ºå®š / CDC / Isolate å¹¶å‘
- âœ… **è·¨å¹³å° FFI** - Go åŸç”Ÿæ€§èƒ½ï¼ŒDart æ— ç¼è°ƒç”¨
- âœ… **å¢é‡åŒæ­¥** - 98%+ æµé‡èŠ‚çœ
- âœ… **ç«¯åˆ°ç«¯åŠ å¯†** - AES-256ï¼Œäº‘ç«¯é›¶çŸ¥è¯†
- âœ… **å†…å®¹å»é‡** - SHA-1 å“ˆå¸Œï¼Œè‡ªåŠ¨å»é‡
- âœ… **æ•°æ®å‹ç¼©** - ZLib é«˜æ•ˆå‹ç¼©
- âœ… **åŒå‘åŒæ­¥** - è‡ªåŠ¨æ£€æµ‹ä¸Šä¼ /ä¸‹è½½æ–¹å‘
- âœ… **äº‘ç«¯å¤‡ä»½** - S3 å…¼å®¹å­˜å‚¨ï¼ˆé˜¿é‡Œäº‘ OSSï¼‰
- âœ… **å¹¶å‘æ§åˆ¶** - é¿å…äº‘ç«¯ API è¿‡è½½
- âœ… **å®Œæ•´æ€§æ ¡éªŒ** - 100% æ•°æ®ä¸€è‡´æ€§ä¿è¯

---

## ğŸ“š æ–‡æ¡£

- ğŸ“– [æ„å»ºæŒ‡å—](chunker-ffi/BUILD_GUIDE.md) - FFI åº“æ„å»ºè¯¦è§£
- ğŸ“ [è´¡çŒ®æŒ‡å—](CONTRIBUTING.md) - å¦‚ä½•å‚ä¸å¼€å‘
- ğŸ“‹ [å˜æ›´æ—¥å¿—](CHANGELOG.md) - ç‰ˆæœ¬å†å²

---

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

åœ¨æäº¤ä»£ç å‰ï¼Œè¯·ç¡®ä¿ï¼š
1. è¿è¡Œ `dart format .`
2. è¿è¡Œ `dart analyze` æ— é”™è¯¯
3. æµ‹è¯•é€šè¿‡
4. éµå¾ª [Conventional Commits](https://www.conventionalcommits.org/)

---

## ğŸ“„ è®¸å¯è¯

**AGPL-3.0**

æœ¬é¡¹ç›®é‡‡ç”¨ AGPL-3.0 å¼€æºåè®®ï¼Œè¦æ±‚ä¿®æ”¹åçš„ç‰ˆæœ¬ä¹Ÿå¿…é¡»å¼€æºã€‚

---

## ğŸ™ è‡´è°¢

- [DejaVu](https://github.com/siyuan-note/dejavu) - åŸå§‹è®¾è®¡å’Œçµæ„Ÿæ¥æº
- [restic/chunker](https://github.com/restic/chunker) - ä¹…ç»è€ƒéªŒçš„ CDC ç®—æ³•
- [Dart FFI](https://dart.dev/guides/libraries/c-interop) - å¼ºå¤§çš„è·¨è¯­è¨€äº’æ“ä½œ

---

## ğŸ“Š é¡¹ç›®çŠ¶æ€

| æŒ‡æ ‡ | çŠ¶æ€ |
|------|------|
| **ç‰ˆæœ¬** | 1.0.0 |
| **çŠ¶æ€** | âœ… ç”Ÿäº§å¯ç”¨ |
| **Dart SDK** | â‰¥ 3.0.0 |
| **å¹³å°æ”¯æŒ** | macOS / Linux / Windows / Android |
| **æœ€åæ›´æ–°** | 2026-01-04 |

---

<p align="center">
  Made with â¤ï¸ by Flow Repo Team
</p>